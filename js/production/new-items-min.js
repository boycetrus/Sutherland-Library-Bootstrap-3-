$(document).ready(function(){function e(e){$(".loading").fadeOut("fast"),$('<p id="fallbackLink">Try this Link instead: <a></a></p>').appendTo("#newItemsFail"),$("#fallbackLink > a").attr("href",fallbackURL).text(feedName),$("#newItemsFail").removeClass("hide")}function t(e,t,a,o,i){void 0!==a?$('<div class="panel panel-default"><div class="panel-heading"><h3 class="panel-title"><a target="_blank" href="'+t+'">'+e+'</a></h3></div><div class="panel-body"><p>'+a+'</p><p><a data-isbn="'+o+'" data-bib="'+i+'" data-url="'+t+'" data-title="'+e+'" href="#!">More Info</a></p></div></div>').appendTo("#newItems"):$('<div class="panel panel-default" data-isbn="'+o+'" data-bib="'+i+'"><div class="panel-heading"><h3 class="panel-title"><a target="_blank" href="'+t+'">'+e+'</a></h3></div><div class="panel-body"><p><a data-isbn="'+o+'" data-bib="'+i+'" data-url="'+t+'" data-title="'+e+'" href="#!">More Info</a></p></div></div>').appendTo("#newItems"),$("#newItems .panel-body a").addClass("fire-gbks btn btn-info")}function a(a,o,i){var s="http://webpac.sutherlandshire.nsw.gov.au/feeds/"+a+".xml",n="https://query.yahooapis.com/v1/public/yql?q=select%20*%20from%20rss%20where%20url%3D'http%3A%2F%2Fwebpac.sutherlandshire.nsw.gov.au%2Ffeeds%2F"+a+".xml'&format=json&diagnostics=true&callback=?",l="http://feedburner.google.com/fb/a/mailverify?uri=SutherlandShireLibraries"+a+"&loc=en_US";$.getJSON(n,function(){console.log("json request:"+n),console.log("success")}).done(function(a){if(console.log("retrieved JSON data"),$(".loading").hide(),$("#newItemsData > h2").text(o),$("#emailSubscribe").attr("href",l),$("#rssSubscribe").attr("href",s),$("#newItems").empty(),1===a.query.count){var n=a.query.results.item.title,r=a.query.results.item.link,d=a.query.results.item.description,c=a.query.results.item.guid.content.split(" ",1),u=r.toString().substring(48,56),m="http://encore.sutherlandshire.nsw.gov.au/iii/encore/record/C__R"+u;t(n,m,d,c,u)}else a.query.count>1?$.each(a.query.results.item,function(e,a){var o=a.title,i=a.link,s=a.description,n=a.guid.content.split(" ",1),l=i.toString().substring(48,56),r="http://encore.sutherlandshire.nsw.gov.au/iii/encore/record/C__R"+l;t(o,r,s,n,l)}):(console.log("no data retrieved"),e(i));$(".new-items-data").fadeIn("slow")}).fail(function(){console.log("fail"),e(i)}).error(function(){console.log("error"),e(i)})}function o(e,t,a){var o="https://www.googleapis.com/books/v1/volumes?q=isbn:"+e;$.getJSON(o,function(){console.log("Google Books JSON request successful")}).done(function(o){if(o.totalItems>0){console.log(o);var i=o.items[0].volumeInfo.imageLinks,s=o.items[0].volumeInfo.description,n=o.items[0].searchInfo,l=o.items[0].accessInfo.webReaderLink,r,d;r=void 0!==i?o.items[0].volumeInfo.imageLinks.thumbnail:"img/no-cover.png",d=void 0!==s?s:void 0!==n?n.textSnippet:"Houston, we have a problem; there's no summary on Google Books",$(".modal-header h4").text(a),$(".modal-body").empty(),$('<div class="gbks-cover"><img id="coverImage" alt="cover image" /></div><div class="gbks-summary"><p id="isbn"></p><p id="summary"></p></div>').appendTo(".modal-body"),$("#coverImage").attr("src",r),$("#isbn").text("ISBN: "+e),$("#summary").text(d),$(".modal-footer .btn-success").text("Request it!").attr("href",t),$(".modal-footer .btn-default").removeAttr("disabled").attr("href",l),$("#bookDetails").modal()}else{console.log("Sorry, no information found for that book");var c="Bad news friend. It looks like we could not get any extra information about that title. Best go straight to the Library Catalogue for more.";$(".modal-header h4").text(a),$(".modal-body").empty(),$(".modal-body").html('<p id="message">'+c+"</p>"),$(".modal-footer .btn-success").text("View Catalogue").attr("href",t),$(".modal-footer .btn-default").attr("disabled","disabled"),$("#bookDetails").modal()}})}$(".loader").on("click",function(e){$(".new-items-data").hide(),$(".new-items-fail").hide(),$(".loading").fadeIn("fast");var t=$(this).data("feed"),o=$(this).text(),i="http://webpac.sutherlandshire.nsw.gov.au/screens/"+t+".html";a(t,o,i),e.preventDefault()}),$("#newItems").on("click",".fire-gbks",function(e){var t=$(this).data("isbn"),a=$(this).data("url").toString(),i=$(this).data("title");console.log(t,a,i),o(t,a,i),e.preventDefault()}),a("newadultfiction","New Fiction")});